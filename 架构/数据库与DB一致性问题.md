
# 问题

1. 写时不一致
    1. 请求A删除缓存
    2. 请求A更新数据库修改为1
    3. 请求B删除缓存
    4. 请求B更新数据库修改为2
    5. 请求B和请求A先后更新缓存，此时为A的数据=1
2. 读写不一致
    1. 写请求A删除缓存，原值为1
    2. 读请求B读缓存没有数据，去读数据库得到1
    3. 写请求A更新数据库为2
    4. 写请求A更新缓存为2
    5. 读请求B更新缓存为1

# 方案

（1）写请求串行化
1. 写请求：获取分布式锁写数据到数据库，后刷新缓存，刷新失败走内存队列重试
2. 读请求：读缓存 -> 读数据库 -> 写缓存

**总结：最终一致性**
- 通过分布式锁保障写入安全
- 刷新缓存前读到的是老数据


（2）先更新数据库，异步重试删除缓存
1. 先更新数据库
2. 异步删除缓存
3. 删除失败重试

**总结：最终一致性**
- DB写成功后，写请求不更新缓存，而删除缓存
- 删除缓存是为了让读线程能够重新去DB获取数据来刷新缓存
- 删除缓存前读到的还是老数据


（3）监听DB事件更新缓存


